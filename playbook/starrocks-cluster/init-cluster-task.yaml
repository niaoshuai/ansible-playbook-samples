- name: 下载压缩包
  ansible.builtin.get_url:
    url: "http://i-ansible.oss-cn-hangzhou-internal.aliyuncs.com/{{ starrocks_tar_name }}"
    validate_certs: false
    dest: "/tmp/{{ starrocks_tar_name }}"
    mode: "0755"
    force: true
    owner: "{{ starrocks_install_user }}"
    group: "{{ starrocks_install_user }}"

- name: 创建目录
  ansible.builtin.file:
    name: "{{ item }}"
    state: directory
    mode: "0755"
  become_user: "{{ starrocks_install_user }}"
  with_items:
    - "{{ starrocks_install_dir }}"
    - "{{ starrocks_fe_meta_dir }}"

- name: 解压
  ansible.builtin.unarchive:
    remote_src: true
    src: "/tmp/{{ starrocks_tar_name }}"
    dest: "{{ starrocks_install_dir }}"
    owner: "{{ starrocks_install_user }}"
    group: "{{ starrocks_install_user }}"
  become_user: "{{ starrocks_install_user }}"

- name: 复制启动文件
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "{{ starrocks_service_dir }}/{{ item }}"
    mode: "0755"
    owner: root
    group: root
  with_items:
    - "{{ starrocks_fe_service_file }}"
  notify: Reload StarRocks FE

- name: 立即执行 handler
  ansible.builtin.meta: flush_handlers

- name: 检查端口是否运行
  ansible.builtin.wait_for:
    port: "{{ item }}"
    state: started
    delay: 5
    timeout: 30
  with_items:
    - 8030
    - 9020
    - 9030
    # - 9010
